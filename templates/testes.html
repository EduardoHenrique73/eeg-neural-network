<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema EEG - Testes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .testes-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .testes-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .testes-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .testes-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .botoes-teste {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .btn-teste {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-teste.primario {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-teste.secundario {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-teste:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .btn-teste:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .status-idle {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .status-running {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .logs-container {
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .logs-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .logs-container::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 4px;
        }
        
        .logs-container::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        .logs-container::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        
        .navegacao {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .nav-link {
            padding: 12px 24px;
            background: #f8f9fa;
            color: #495057;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: #e9ecef;
            color: #212529;
        }
        
        .nav-link.ativo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .resultado-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card-resultado {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .card-resultado h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .card-resultado .valor {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="testes-container">
        <!-- Navega√ß√£o -->
        <div class="navegacao">
            <a href="/" class="nav-link">üè† In√≠cio</a>
            <a href="/dashboard" class="nav-link">üìä Dashboard</a>
            <a href="/testes" class="nav-link ativo">üß™ Testes</a>
        </div>
        
        <!-- Header -->
        <div class="testes-header">
            <h1>üß™ Testes do Sistema</h1>
            <p>Execute testes automatizados para verificar o funcionamento de todos os componentes</p>
        </div>
        
        <!-- Bot√µes de a√ß√£o -->
        <div class="botoes-teste">
            <button id="btnRetreinar" class="btn-teste primario">
                üîÑ Retreinar Modelo
            </button>
            <button id="btnExecutarTestes" class="btn-teste secundario">
                üß™ Executar Testes
            </button>
        </div>
        
        <!-- Status do Retreinamento -->
        <div class="status-container">
            <h3>üîÑ Status do Retreinamento</h3>
            <div id="statusRetreinamento" class="status-indicator status-idle">
                <span>‚è∏Ô∏è</span>
                <span>Ocioso</span>
            </div>
            <div id="logsRetreinamento" class="logs-container" style="display: none;"></div>
        </div>
        
        <!-- Status dos Testes -->
        <div class="status-container">
            <h3>üß™ Status dos Testes</h3>
            <div id="statusTestes" class="status-indicator status-idle">
                <span>‚è∏Ô∏è</span>
                <span>Ocioso</span>
            </div>
            <div id="logsTestes" class="logs-container" style="display: none;"></div>
        </div>
        
        <!-- Resumo dos Resultados -->
        <div id="resumoResultados" class="resultado-resumo" style="display: none;">
            <div class="card-resultado">
                <h3>‚è±Ô∏è Tempo Total</h3>
                <div class="valor" id="tempoTotal">-</div>
            </div>
            <div class="card-resultado">
                <h3>‚úÖ Testes Passaram</h3>
                <div class="valor" id="testesSucesso">-</div>
            </div>
            <div class="card-resultado">
                <h3>üìä Total de Testes</h3>
                <div class="valor" id="totalTestes">-</div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let retrainingInterval = null;
        let testesInterval = null;
        
        // Elementos DOM
        const btnRetreinar = document.getElementById('btnRetreinar');
        const btnExecutarTestes = document.getElementById('btnExecutarTestes');
        const statusRetreinamento = document.getElementById('statusRetreinamento');
        const logsRetreinamento = document.getElementById('logsRetreinamento');
        const statusTestes = document.getElementById('statusTestes');
        const logsTestes = document.getElementById('logsTestes');
        const resumoResultados = document.getElementById('resumoResultados');
        
        // Fun√ß√£o para atualizar status do retreinamento
        function atualizarStatusRetreinamento() {
            fetch('/status_retreinamento')
                .then(response => response.json())
                .then(data => {
                    const status = data.status;
                    const logs = data.logs;
                    
                    // Atualizar indicador de status
                    statusRetreinamento.className = `status-indicator status-${status}`;
                    
                    if (status === 'idle') {
                        statusRetreinamento.innerHTML = '<span>‚è∏Ô∏è</span><span>Ocioso</span>';
                        logsRetreinamento.style.display = 'none';
                        btnRetreinar.disabled = false;
                        btnRetreinar.innerHTML = 'üîÑ Retreinar Modelo';
                        if (retrainingInterval) {
                            clearInterval(retrainingInterval);
                            retrainingInterval = null;
                        }
                    } else if (status === 'running') {
                        statusRetreinamento.innerHTML = '<span class="spinner"></span><span>Executando...</span>';
                        logsRetreinamento.style.display = 'block';
                        logsRetreinamento.textContent = logs.join('\n');
                        logsRetreinamento.scrollTop = logsRetreinamento.scrollHeight;
                        btnRetreinar.disabled = true;
                        btnRetreinar.innerHTML = 'üîÑ Executando...';
                    } else if (status === 'completed') {
                        statusRetreinamento.innerHTML = '<span>‚úÖ</span><span>Conclu√≠do</span>';
                        logsRetreinamento.style.display = 'block';
                        logsRetreinamento.textContent = logs.join('\n');
                        logsRetreinamento.scrollTop = logsRetreinamento.scrollHeight;
                        btnRetreinar.disabled = false;
                        btnRetreinar.innerHTML = 'üîÑ Retreinar Modelo';
                        if (retrainingInterval) {
                            clearInterval(retrainingInterval);
                            retrainingInterval = null;
                        }
                    } else if (status === 'error') {
                        statusRetreinamento.innerHTML = '<span>‚ùå</span><span>Erro</span>';
                        logsRetreinamento.style.display = 'block';
                        logsRetreinamento.textContent = logs.join('\n');
                        logsRetreinamento.scrollTop = logsRetreinamento.scrollHeight;
                        btnRetreinar.disabled = false;
                        btnRetreinar.innerHTML = 'üîÑ Retreinar Modelo';
                        if (retrainingInterval) {
                            clearInterval(retrainingInterval);
                            retrainingInterval = null;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status do retreinamento:', error);
                });
        }
        
        // Fun√ß√£o para atualizar status dos testes
        function atualizarStatusTestes() {
            fetch('/status_testes')
                .then(response => response.json())
                .then(data => {
                    const status = data.status;
                    const logs = data.logs;
                    
                    // Atualizar indicador de status
                    statusTestes.className = `status-indicator status-${status}`;
                    
                    if (status === 'idle') {
                        statusTestes.innerHTML = '<span>‚è∏Ô∏è</span><span>Ocioso</span>';
                        logsTestes.style.display = 'none';
                        btnExecutarTestes.disabled = false;
                        btnExecutarTestes.innerHTML = 'üß™ Executar Testes';
                        resumoResultados.style.display = 'none';
                        if (testesInterval) {
                            clearInterval(testesInterval);
                            testesInterval = null;
                        }
                    } else if (status === 'running') {
                        statusTestes.innerHTML = '<span class="spinner"></span><span>Executando...</span>';
                        logsTestes.style.display = 'block';
                        logsTestes.textContent = logs.join('\n');
                        logsTestes.scrollTop = logsTestes.scrollHeight;
                        btnExecutarTestes.disabled = true;
                        btnExecutarTestes.innerHTML = 'üß™ Executando...';
                    } else if (status === 'completed') {
                        statusTestes.innerHTML = '<span>‚úÖ</span><span>Conclu√≠do</span>';
                        logsTestes.style.display = 'block';
                        logsTestes.textContent = logs.join('\n');
                        logsTestes.scrollTop = logsTestes.scrollHeight;
                        btnExecutarTestes.disabled = false;
                        btnExecutarTestes.innerHTML = 'üß™ Executar Testes';
                        resumoResultados.style.display = 'grid';
                        
                        // Extrair informa√ß√µes do resumo dos logs
                        const ultimoLog = logs[logs.length - 1];
                        if (ultimoLog && ultimoLog.includes('Testes passaram:')) {
                            const match = ultimoLog.match(/(\d+)\/(\d+)/);
                            if (match) {
                                document.getElementById('testesSucesso').textContent = match[1];
                                document.getElementById('totalTestes').textContent = match[2];
                            }
                        }
                        
                        // Extrair tempo total
                        const tempoLog = logs.find(log => log.includes('Testes conclu√≠dos em'));
                        if (tempoLog) {
                            const tempoMatch = tempoLog.match(/(\d+\.\d+)s/);
                            if (tempoMatch) {
                                document.getElementById('tempoTotal').textContent = tempoMatch[1] + 's';
                            }
                        }
                        
                        if (testesInterval) {
                            clearInterval(testesInterval);
                            testesInterval = null;
                        }
                    } else if (status === 'error') {
                        statusTestes.innerHTML = '<span>‚ùå</span><span>Erro</span>';
                        logsTestes.style.display = 'block';
                        logsTestes.textContent = logs.join('\n');
                        logsTestes.scrollTop = logsTestes.scrollHeight;
                        btnExecutarTestes.disabled = false;
                        btnExecutarTestes.innerHTML = 'üß™ Executar Testes';
                        if (testesInterval) {
                            clearInterval(testesInterval);
                            testesInterval = null;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status dos testes:', error);
                });
        }
        
        // Event listeners
        btnRetreinar.addEventListener('click', function() {
            fetch('/retreinar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    // Iniciar polling do status
                    if (!retrainingInterval) {
                        retrainingInterval = setInterval(atualizarStatusRetreinamento, 1000);
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Erro ao iniciar retreinamento:', error);
                alert('Erro ao iniciar retreinamento');
            });
        });
        
        btnExecutarTestes.addEventListener('click', function() {
            fetch('/executar_testes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    // Iniciar polling do status
                    if (!testesInterval) {
                        testesInterval = setInterval(atualizarStatusTestes, 1000);
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Erro ao iniciar testes:', error);
                alert('Erro ao iniciar testes');
            });
        });
        
        // Inicializar status ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            atualizarStatusRetreinamento();
            atualizarStatusTestes();
        });
    </script>
</body>
</html>
