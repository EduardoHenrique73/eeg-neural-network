{% extends "base.html" %}

{% block title %}Dashboard - Análise EEG{% endblock %}

{% block extra_head %}
<style>
    /* Estilos específicos para dashboard */
    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: var(--white);
        padding: var(--spacing-8);
        border-radius: var(--border-radius-lg);
        margin-bottom: var(--spacing-6);
    }
    
    .dashboard-title {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        margin-bottom: var(--spacing-4);
    }
    
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-4);
        margin-top: var(--spacing-6);
    }
    
    .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: var(--spacing-4);
        border-radius: var(--border-radius);
        text-align: center;
    }
    
    .stat-value {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-1);
    }
    
    .stat-label {
        font-size: var(--font-size-sm);
        opacity: 0.8;
    }
    
    /* Filtros */
    .filters-section {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-6);
        box-shadow: var(--shadow);
        margin-bottom: var(--spacing-6);
    }
    
    .filters-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-4);
        flex-wrap: wrap;
        gap: var(--spacing-4);
    }
    
    .filters-title {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--gray-900);
    }
    
    .filters-controls {
        display: flex;
        gap: var(--spacing-3);
        flex-wrap: wrap;
    }
    
    .filter-select {
        padding: var(--spacing-2) var(--spacing-3);
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        background: var(--white);
        color: var(--gray-700);
        font-size: var(--font-size-sm);
        transition: var(--transition);
    }
    
    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* Sinais Grid */
    .signals-section {
        margin-bottom: var(--spacing-8);
    }
    
    .signals-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-6);
        flex-wrap: wrap;
        gap: var(--spacing-4);
    }
    
    .signals-title {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--gray-900);
    }
    
    .signals-count {
        font-size: var(--font-size-sm);
        color: var(--gray-600);
        background: var(--gray-100);
        padding: var(--spacing-2) var(--spacing-3);
        border-radius: var(--border-radius);
    }
    
    .signals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-6);
    }
    
    .signal-card {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-6);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        cursor: pointer;
    }
    
    .signal-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .signal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-4);
    }
    
    .signal-name {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-1);
    }
    
    .signal-category {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-1);
        padding: var(--spacing-1) var(--spacing-2);
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .signal-category.sim {
        background: rgba(16, 185, 129, 0.1);
        color: #065f46;
    }
    
    .signal-category.nao {
        background: rgba(239, 68, 68, 0.1);
        color: #991b1b;
    }
    
    .signal-date {
        font-size: var(--font-size-sm);
        color: var(--gray-500);
    }
    
    .signal-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-3);
        margin-bottom: var(--spacing-4);
    }
    
    .signal-metric {
        text-align: center;
        padding: var(--spacing-3);
        background: var(--gray-50);
        border-radius: var(--border-radius);
    }
    
    .signal-metric-label {
        font-size: var(--font-size-xs);
        color: var(--gray-600);
        margin-bottom: var(--spacing-1);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .signal-metric-value {
        font-size: var(--font-size-lg);
        font-weight: 700;
        color: var(--gray-900);
    }
    
    .signal-predictions {
        display: flex;
        gap: var(--spacing-2);
        flex-wrap: wrap;
    }
    
    .prediction-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-1);
        padding: var(--spacing-1) var(--spacing-2);
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        font-weight: 600;
    }
    
    .prediction-badge.sim {
        background: rgba(16, 185, 129, 0.1);
        color: #065f46;
    }
    
    .prediction-badge.nao {
        background: rgba(239, 68, 68, 0.1);
        color: #991b1b;
    }
    
    /* Gráficos */
    .charts-section {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-6);
        box-shadow: var(--shadow);
        margin-bottom: var(--spacing-6);
    }
    
    .charts-header {
        text-align: center;
        margin-bottom: var(--spacing-6);
    }
    
    .charts-title {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: var(--spacing-2);
    }
    
    .charts-description {
        font-size: var(--font-size-sm);
        color: var(--gray-600);
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--spacing-6);
    }
    
    .chart-container {
        background: var(--gray-50);
        border-radius: var(--border-radius);
        padding: var(--spacing-4);
        min-height: 300px;
    }
    
    /* Estados vazios */
    .empty-state {
        text-align: center;
        padding: var(--spacing-12);
        color: var(--gray-500);
    }
    
    .empty-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-4);
        opacity: 0.5;
    }
    
    .empty-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        margin-bottom: var(--spacing-2);
    }
    
    .empty-description {
        font-size: var(--font-size-sm);
        margin-bottom: var(--spacing-6);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header do Dashboard -->
<div class="dashboard-header">
    <h1 class="dashboard-title">
        <i class="fas fa-chart-line"></i>
        Dashboard de Análise EEG
    </h1>
    <p class="text-lg opacity-90">
        Visão geral completa dos sinais EEG e análises realizadas
    </p>
    
    <div class="dashboard-stats">
        <div class="stat-item">
            <div class="stat-value">{{ total_sinais }}</div>
            <div class="stat-label">Total de Sinais</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ sinais_sim }}</div>
            <div class="stat-label">Grupo Sim</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ sinais_nao }}</div>
            <div class="stat-label">Grupo Não</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ "%.1f"|format(taxa_acerto * 100) }}%</div>
            <div class="stat-label">Taxa de Acerto</div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="filters-section">
    <div class="filters-header">
        <h3 class="filters-title">
            <i class="fas fa-filter"></i>
            Filtros
        </h3>
        <div class="filters-controls">
            <select class="filter-select" id="categoriaFilter" onchange="filtrarSinais()">
                <option value="">Todas as Categorias</option>
                <option value="S">Grupo Sim</option>
                <option value="N">Grupo Não</option>
            </select>
            
            <select class="filter-select" id="ordenacaoFilter" onchange="filtrarSinais()">
                <option value="data_desc">Mais Recentes</option>
                <option value="data_asc">Mais Antigos</option>
                <option value="entropia_desc">Maior Entropia</option>
                <option value="entropia_asc">Menor Entropia</option>
                <option value="nome_asc">Nome A-Z</option>
                <option value="nome_desc">Nome Z-A</option>
            </select>
        </div>
    </div>
</div>

<!-- Seção de Sinais -->
<div class="signals-section">
    <div class="signals-header">
        <h2 class="signals-title">
            <i class="fas fa-brain"></i>
            Sinais EEG
        </h2>
        <div class="signals-count">
            <span id="signalsCount">{{ total_sinais }}</span> sinais encontrados
        </div>
    </div>
    
    {% if sinais %}
    <div class="signals-grid" id="signalsGrid">
        {% for sinal in sinais %}
        <div class="signal-card" onclick="verSinal({{ sinal.id }})">
            <div class="signal-header">
                <div>
                    <div class="signal-name">{{ sinal.nome_arquivo }}</div>
                    <div class="signal-date">{{ sinal.data_upload.strftime('%d/%m/%Y %H:%M') }}</div>
                </div>
                <div class="signal-category {{ 'sim' if sinal.categoria == 'S' else 'nao' }}">
                    <i class="fas {{ 'fa-check' if sinal.categoria == 'S' else 'fa-times' }}"></i>
                    {{ 'Sim' if sinal.categoria == 'S' else 'Não' }}
                </div>
            </div>
            
            <div class="signal-metrics">
                <div class="signal-metric">
                    <div class="signal-metric-label">Entropia</div>
                    <div class="signal-metric-value">{{ "%.4f"|format(sinal.entropia) }}</div>
                </div>
                <div class="signal-metric">
                    <div class="signal-metric-label">Complexidade</div>
                    <div class="signal-metric-value">{{ "%.4f"|format(sinal.complexidade) }}</div>
                </div>
            </div>
            
            {% if sinal.predicao %}
            <div class="signal-predictions">
                <div class="prediction-badge {{ 'sim' if sinal.predicao.classe_predita == 'Sim' else 'nao' }}">
                    <i class="fas fa-robot"></i>
                    IA: {{ sinal.predicao.classe_predita }}
                </div>
                {% if sinal.predicao_cnn %}
                <div class="prediction-badge {{ 'sim' if sinal.predicao_cnn.classe_predita == 'Sim' else 'nao' }}">
                    <i class="fas fa-network-wired"></i>
                    CNN: {{ sinal.predicao_cnn.classe_predita }}
                </div>
                {% endif %}
                {% if sinal.predicao_lstm %}
                <div class="prediction-badge {{ 'sim' if sinal.predicao_lstm.classe_predita == 'Sim' else 'nao' }}">
                    <i class="fas fa-stream"></i>
                    LSTM: {{ sinal.predicao_lstm.classe_predita }}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="empty-title">Nenhum sinal encontrado</div>
        <div class="empty-description">
            Faça upload de arquivos EEG para começar a análise
        </div>
        <a href="{{ url_for('pagina_upload') }}" class="btn btn-primary">
            <i class="fas fa-upload"></i>
            Fazer Upload
        </a>
    </div>
    {% endif %}
</div>

<!-- Gráficos -->
{% if sinais %}
<div class="charts-section">
    <div class="charts-header">
        <h3 class="charts-title">
            <i class="fas fa-chart-bar"></i>
            Análises Estatísticas
        </h3>
        <p class="charts-description">
            Visualize distribuições e tendências dos dados EEG
        </p>
    </div>
    
    <div class="charts-grid">
        <div class="chart-container" id="distribuicaoChart">
            <!-- Gráfico de distribuição será inserido aqui -->
        </div>
        <div class="chart-container" id="entropiaChart">
            <!-- Gráfico de entropia será inserido aqui -->
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
    // Dados dos sinais
    const sinaisData = {{ sinais_json|safe }};
    
    // Filtrar sinais
    function filtrarSinais() {
        const categoria = document.getElementById('categoriaFilter').value;
        const ordenacao = document.getElementById('ordenacaoFilter').value;
        
        let sinaisFiltrados = [...sinaisData];
        
        // Filtrar por categoria
        if (categoria) {
            sinaisFiltrados = sinaisFiltrados.filter(sinal => sinal.categoria === categoria);
        }
        
        // Ordenar
        sinaisFiltrados.sort((a, b) => {
            switch (ordenacao) {
                case 'data_desc':
                    return new Date(b.data_upload) - new Date(a.data_upload);
                case 'data_asc':
                    return new Date(a.data_upload) - new Date(b.data_upload);
                case 'entropia_desc':
                    return b.entropia - a.entropia;
                case 'entropia_asc':
                    return a.entropia - b.entropia;
                case 'nome_asc':
                    return a.nome_arquivo.localeCompare(b.nome_arquivo);
                case 'nome_desc':
                    return b.nome_arquivo.localeCompare(a.nome_arquivo);
                default:
                    return 0;
            }
        });
        
        // Atualizar contador
        document.getElementById('signalsCount').textContent = sinaisFiltrados.length;
        
        // Atualizar grid
        atualizarGridSinais(sinaisFiltrados);
    }
    
    // Atualizar grid de sinais
    function atualizarGridSinais(sinais) {
        const grid = document.getElementById('signalsGrid');
        
        if (sinais.length === 0) {
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="empty-title">Nenhum sinal encontrado</div>
                    <div class="empty-description">
                        Tente ajustar os filtros ou fazer upload de novos arquivos
                    </div>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = sinais.map(sinal => `
            <div class="signal-card" onclick="verSinal(${sinal.id})">
                <div class="signal-header">
                    <div>
                        <div class="signal-name">${sinal.nome_arquivo}</div>
                        <div class="signal-date">${formatarData(sinal.data_upload)}</div>
                    </div>
                    <div class="signal-category ${sinal.categoria === 'S' ? 'sim' : 'nao'}">
                        <i class="fas ${sinal.categoria === 'S' ? 'fa-check' : 'fa-times'}"></i>
                        ${sinal.categoria === 'S' ? 'Sim' : 'Não'}
                    </div>
                </div>
                
                <div class="signal-metrics">
                    <div class="signal-metric">
                        <div class="signal-metric-label">Entropia</div>
                        <div class="signal-metric-value">${sinal.entropia.toFixed(4)}</div>
                    </div>
                    <div class="signal-metric">
                        <div class="signal-metric-label">Complexidade</div>
                        <div class="signal-metric-value">${sinal.complexidade.toFixed(4)}</div>
                    </div>
                </div>
                
                ${sinal.predicao ? `
                <div class="signal-predictions">
                    <div class="prediction-badge ${sinal.predicao.classe_predita === 'Sim' ? 'sim' : 'nao'}">
                        <i class="fas fa-robot"></i>
                        IA: ${sinal.predicao.classe_predita}
                    </div>
                    ${sinal.predicao_cnn ? `
                    <div class="prediction-badge ${sinal.predicao_cnn.classe_predita === 'Sim' ? 'sim' : 'nao'}">
                        <i class="fas fa-network-wired"></i>
                        CNN: ${sinal.predicao_cnn.classe_predita}
                    </div>
                    ` : ''}
                    ${sinal.predicao_lstm ? `
                    <div class="prediction-badge ${sinal.predicao_lstm.classe_predita === 'Sim' ? 'sim' : 'nao'}">
                        <i class="fas fa-stream"></i>
                        LSTM: ${sinal.predicao_lstm.classe_predita}
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
        `).join('');
    }
    
    // Formatar data
    function formatarData(dataString) {
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Ver sinal
    function verSinal(id) {
        window.location.href = `/?sinal_id=${id}`;
    }
    
    // Criar gráficos quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        if (sinaisData && sinaisData.length > 0) {
            criarGraficos();
        }
    });
    
    // Criar gráficos
    function criarGraficos() {
        // Gráfico de distribuição por categoria
        const categorias = sinaisData.reduce((acc, sinal) => {
            acc[sinal.categoria] = (acc[sinal.categoria] || 0) + 1;
            return acc;
        }, {});
        
        const distribuicaoData = [{
            x: ['Grupo Sim', 'Grupo Não'],
            y: [categorias.S || 0, categorias.N || 0],
            type: 'bar',
            marker: {
                color: ['#10b981', '#ef4444']
            }
        }];
        
        const distribuicaoLayout = {
            title: 'Distribuição por Categoria',
            xaxis: { title: 'Categoria' },
            yaxis: { title: 'Quantidade' }
        };
        
        Plotly.newPlot('distribuicaoChart', distribuicaoData, distribuicaoLayout);
        
        // Gráfico de entropia vs complexidade
        const entropiaData = [{
            x: sinaisData.map(s => s.entropia),
            y: sinaisData.map(s => s.complexidade),
            mode: 'markers',
            type: 'scatter',
            marker: {
                color: sinaisData.map(s => s.categoria === 'S' ? '#10b981' : '#ef4444'),
                size: 8
            },
            text: sinaisData.map(s => s.nome_arquivo),
            hovertemplate: '<b>%{text}</b><br>Entropia: %{x}<br>Complexidade: %{y}<extra></extra>'
        }];
        
        const entropiaLayout = {
            title: 'Entropia vs Complexidade',
            xaxis: { title: 'Entropia' },
            yaxis: { title: 'Complexidade' }
        };
        
        Plotly.newPlot('entropiaChart', entropiaData, entropiaLayout);
    }
</script>
{% endblock %} 